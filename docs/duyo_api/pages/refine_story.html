<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì´ì•¼ê¸° ê°€ê³µí•˜ê¸° - Duyo</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .scene-box {
            background-color: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 0.5rem;
            padding: 1rem;
            margin-bottom: 1rem;
        }
        .scene-title {
            font-weight: 600;
            color: #1e40af;
            margin-bottom: 0.5rem;
        }
        .scene-location {
            color: #4b5563;
            font-size: 0.875rem;
            font-style: italic;
            margin-bottom: 0.5rem;
        }
        .character-list {
            background-color: #f3f4f6;
            border-radius: 0.375rem;
            padding: 1rem;
            margin-bottom: 1rem;
        }
        .character-item {
            color: #4b5563;
            margin-bottom: 0.25rem;
        }
        .dialogue {
            background-color: #e8f4ff;
            border-radius: 0.375rem;
            padding: 0.5rem 0.75rem;
            margin: 0.5rem 0;
            display: inline-block;
        }
        
        .speaker {
            color: #2563eb;
            cursor: pointer;
            position: relative;
        }
        
        /* ì±„íŒ… ë©”ì‹œì§€ ìŠ¤íƒ€ì¼ */
        .chat-message-user {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 0.75rem 1rem;
            border-radius: 1rem;
            border-bottom-right-radius: 0.25rem;
            max-width: 80%;
            word-wrap: break-word;
        }
        
        .chat-message-ai {
            background-color: #ffffff;
            color: #1f2937;
            padding: 0.75rem 1rem;
            border-radius: 1rem;
            border-bottom-left-radius: 0.25rem;
            max-width: 80%;
            word-wrap: break-word;
            border: 1px solid #e5e7eb;
        }
        
        /* ìŠ¤í¬ë¡¤ë°” ìŠ¤íƒ€ì¼ */
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
        }
        
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }
        
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        
        /* ì…ë ¥ì°½ í¬ì»¤ìŠ¤ ìŠ¤íƒ€ì¼ */
        .chat-input:focus {
            outline: none;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        
        /* ë¡œë”© ì• ë‹ˆë©”ì´ì…˜ */
        .typing-indicator {
            display: flex;
            gap: 4px;
            padding: 1rem;
        }
        
        .typing-dot {
            width: 8px;
            height: 8px;
            background-color: #9ca3af;
            border-radius: 50%;
            animation: typing 1.4s infinite;
        }
        
        .typing-dot:nth-child(2) {
            animation-delay: 0.2s;
        }
        
        .typing-dot:nth-child(3) {
            animation-delay: 0.4s;
        }
        
        @keyframes typing {
            0%, 60%, 100% {
                transform: translateY(0);
            }
            30% {
                transform: translateY(-10px);
            }
        }
    </style>
</head>
<body class="bg-gray-50 h-screen overflow-hidden">
    <div class="h-screen flex flex-col">
        <!-- ë©”ì¸ ì»¨í…ì¸  -->
        <main class="flex-1 flex overflow-hidden">
            <!-- ì¢Œì¸¡: ì´ì•¼ê¸° ì˜ì—­ -->
            <div class="w-2/3 bg-white border-r border-gray-200 flex flex-col">
                <!-- ì´ì•¼ê¸° ì œëª© -->
                <div class="p-6 border-b border-gray-200">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-3">
                            <button onclick="window.location.href='api_test.html'" class="text-gray-600 hover:text-gray-900 transition-colors" title="ë©”ì¸ìœ¼ë¡œ ëŒì•„ê°€ê¸°">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/>
                                </svg>
                            </button>
                            <h2 id="storyTitle" class="text-2xl font-bold text-gray-900">ì´ì•¼ê¸° ì œëª©</h2>
                        </div>
                        <div class="flex items-center gap-2">
                            <button id="undoBtn" class="p-2 text-gray-600 hover:text-blue-600 hover:bg-blue-50 rounded-lg transition-colors disabled:opacity-30 disabled:cursor-not-allowed disabled:hover:text-gray-600 disabled:hover:bg-transparent" title="ì´ì „ ë‹¨ê³„ë¡œ" disabled>
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h10a8 8 0 018 8v2M3 10l6 6m-6-6l6-6"/>
                                </svg>
                            </button>
                            <button id="redoBtn" class="p-2 text-gray-600 hover:text-blue-600 hover:bg-blue-50 rounded-lg transition-colors disabled:opacity-30 disabled:cursor-not-allowed disabled:hover:text-gray-600 disabled:hover:bg-transparent" title="ë‹¤ìŒ ë‹¨ê³„ë¡œ" disabled>
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 10h-10a8 8 0 00-8 8v2M21 10l-6 6m6-6l-6-6"/>
                                </svg>
                            </button>
                            <button id="copyStoryBtnTop" class="p-2 text-gray-600 hover:text-gray-900 hover:bg-gray-100 rounded-lg transition-colors" title="ë³µì‚¬í•˜ê¸°">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/>
                                </svg>
                            </button>
                            <button id="resetStoryBtnTop" class="p-2 text-gray-600 hover:text-amber-600 hover:bg-amber-50 rounded-lg transition-colors" title="ì›ë³¸ìœ¼ë¡œ ì´ˆê¸°í™”">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                                </svg>
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- ì´ì•¼ê¸° ë‚´ìš© -->
                <div class="flex-1 flex flex-col overflow-hidden bg-gray-50">
                    <!-- HOOK ì„¹ì…˜ (15% ë†’ì´) -->
                    <div class="flex flex-col border-b border-gray-200" style="flex: 15 1 0;">
                        <div class="px-4 py-2 bg-gray-100 border-b border-gray-200 flex items-center justify-between flex-shrink-0">
                            <div class="flex items-center gap-2">
                                <span class="text-xs font-semibold text-gray-700 uppercase tracking-wide">HOOK</span>
                                <span class="text-xs px-2 py-0.5 bg-gray-200 text-gray-600 rounded-full">0-3ì´ˆ</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <select id="hookTypeSelect" class="text-xs bg-white border border-gray-300 rounded px-2 py-1 focus:outline-none focus:border-blue-500 hover:border-gray-400 transition-colors">
                                    <option value="ìë™" selected>ìë™</option>
                                    <option value="ì§ˆë¬¸í˜•">ì§ˆë¬¸í˜•</option>
                                    <option value="ì¶©ê²©ì‚¬ì‹¤í˜•">ì¶©ê²©ì‚¬ì‹¤í˜•</option>
                                    <option value="ëŒ€ë¹„í˜•">ëŒ€ë¹„í˜•</option>
                                    <option value="ìŠ¤í† ë¦¬ í‹°ì €í˜•">ìŠ¤í† ë¦¬ í‹°ì €í˜•</option>
                                    <option value="í†µê³„ ê°•ì¡°í˜•">í†µê³„ ê°•ì¡°í˜•</option>
                                    <option value="í–‰ë™ ìœ ë„í˜•">í–‰ë™ ìœ ë„í˜•</option>
                                </select>
                                <button id="generateHookBtn" class="text-xs bg-blue-600 text-white rounded hover:bg-blue-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed" style="padding: 4px 8px;">ìë™ìƒì„±</button>
                            </div>
                        </div>
                        <div class="flex-1 p-3 bg-white">
                            <textarea 
                                id="hookContent" 
                                class="w-full h-full px-3 py-2 text-sm bg-gray-50 border border-gray-200 rounded-lg resize-none focus:outline-none focus:bg-white focus:border-gray-400 transition-colors overflow-y-auto"
                                placeholder="ë…ìì˜ ê´€ì‹¬ì„ ë„ëŠ” í›„í¬ë¥¼ ì…ë ¥í•˜ì„¸ìš”..."></textarea>
                        </div>
                    </div>
                    
                    <!-- BODY ì„¹ì…˜ (70% ë†’ì´) -->
                    <div class="flex flex-col border-b border-gray-200" style="flex: 70 1 0;">
                        <div class="px-4 py-2 bg-gray-100 border-b border-gray-200 flex items-center justify-between flex-shrink-0">
                            <div class="flex items-center gap-2">
                                <span class="text-xs font-semibold text-gray-700 uppercase tracking-wide">BODY</span>
                                <span class="text-xs px-2 py-0.5 bg-gray-200 text-gray-600 rounded-full">3-25ì´ˆ</span>
                            </div>
                        </div>
                        <div class="flex-1 p-3 bg-white">
                            <textarea 
                                id="storyContent" 
                                class="w-full h-full px-3 py-2 text-sm bg-gray-50 border border-gray-200 rounded-lg resize-none focus:outline-none focus:bg-white focus:border-gray-400 transition-colors leading-relaxed overflow-y-auto"
                                placeholder="ì´ì•¼ê¸° ë‚´ìš©ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤..."></textarea>
                        </div>
                    </div>
                    
                    <!-- CTA ì„¹ì…˜ (15% ë†’ì´) -->
                    <div class="flex flex-col" style="flex: 15 1 0;">
                        <div class="px-4 py-2 bg-gray-100 border-b border-gray-200 flex items-center justify-between flex-shrink-0">
                            <div class="flex items-center gap-2">
                                <span class="text-xs font-semibold text-gray-700 uppercase tracking-wide">CTA</span>
                                <span class="text-xs px-2 py-0.5 bg-gray-200 text-gray-600 rounded-full">25-30ì´ˆ</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <select id="ctaTypeSelect" class="text-xs bg-white border border-gray-300 rounded px-2 py-1 focus:outline-none focus:border-blue-500 hover:border-gray-400 transition-colors">
                                    <option value="ìë™" selected>ìë™</option>
                                    <option value="ì°¸ì—¬ ìœ ë„í˜•">ì°¸ì—¬ ìœ ë„í˜•</option>
                                    <option value="êµ¬ë…/íŒ”ë¡œìš° ìœ í˜•">êµ¬ë…/íŒ”ë¡œìš°</option>
                                    <option value="í™•ì¥ ì‹œì²­ ìœ ë„í˜•">í™•ì¥ ì‹œì²­ ìœ ë„</option>
                                    <option value="í–‰ë™ ì „í™˜í˜• (ì™¸ë¶€ ìœ ë„)">ì™¸ë¶€ ìœ ë„</option>
                                    <option value="ì¦‰ê° í–‰ë™ ì´‰êµ¬í˜• (FOMO/ê¸´ê¸‰ì„±)">ê¸´ê¸‰ì„± ì´‰êµ¬</option>
                                </select>
                                <button id="generateCtaBtn" class="text-xs bg-blue-600 text-white rounded hover:bg-blue-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed" style="padding: 4px 8px;">ìë™ìƒì„±</button>
                            </div>
                        </div>
                        <div class="flex-1 p-3 bg-white">
                            <textarea 
                                id="ctaContent" 
                                class="w-full h-full px-3 py-2 text-sm bg-gray-50 border border-gray-200 rounded-lg resize-none focus:outline-none focus:bg-white focus:border-gray-400 transition-colors overflow-y-auto"
                                placeholder="í–‰ë™ ìœ ë„ ë©”ì‹œì§€(Call To Action)ë¥¼ ì…ë ¥í•˜ì„¸ìš”..."></textarea>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ìš°ì¸¡: AI ëŒ€í™” ì˜ì—­ -->
            <div class="w-1/3 bg-gradient-to-br from-blue-50 to-indigo-50 flex flex-col">
                <!-- ëŒ€í™” í—¤ë” -->
                <div class="p-4 bg-white border-b border-gray-200">
                    <div class="flex items-center justify-between mb-3">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 bg-gradient-to-br from-blue-500 to-purple-600 rounded-full flex items-center justify-center">
                                <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/>
                                </svg>
                            </div>
                            <div>
                                <h3 class="font-semibold text-gray-900">AI ì–´ì‹œìŠ¤í„´íŠ¸</h3>
                                <p class="text-sm text-gray-500">ì´ì•¼ê¸°ë¥¼ AIì™€ í•¨ê»˜ ìˆ˜ì •í•˜ì„¸ìš”</p>
                            </div>
                        </div>
                        <div class="flex gap-2">
                            <button id="toggleApiLogBtn" class="px-3 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition-colors text-xs flex items-center gap-1 border border-gray-200" title="API ë¡œê·¸ í† ê¸€">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4"/>
                                </svg>
                                API ë¡œê·¸
                            </button>
                            <button id="newChatBtn" class="px-3 py-2 bg-white text-gray-700 rounded-lg hover:bg-gray-50 transition-colors text-xs flex items-center gap-1 border border-gray-200" title="ìƒˆ ì±„íŒ…">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                                </svg>
                                ìƒˆ ì±„íŒ…
                            </button>
                        </div>
                    </div>
                    
                    <!-- OpenRouter API í‚¤ ì…ë ¥ -->
                    <div class="p-3 bg-yellow-50 border border-yellow-200 rounded-lg">
                        <label class="block text-xs font-medium text-gray-700 mb-1">ğŸ”‘ OpenRouter API Key *</label>
                        <input type="text" id="openrouterKey" placeholder="sk-or-v1-... (í•„ìˆ˜)" 
                               class="w-full px-3 py-2 border border-yellow-300 rounded text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white">
                    </div>
                </div>
                
                <!-- API ë¡œê·¸ ì˜ì—­ (í† ê¸€) -->
                <div id="apiLogSection" class="hidden border-b border-gray-200 bg-gray-900 max-h-48 overflow-auto">
                    <div class="p-3">
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-xs text-gray-400 font-semibold">ğŸ“¡ API ìš”ì²­/ì‘ë‹µ ë¡œê·¸</span>
                            <button id="clearApiLogBtn" class="text-xs text-gray-500 hover:text-gray-300">ì§€ìš°ê¸°</button>
                        </div>
                        <pre id="apiLogContent" class="text-xs text-green-400 font-mono whitespace-pre-wrap">ë¡œê·¸ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤...</pre>
                    </div>
                </div>
                
                <!-- ëŒ€í™” ë©”ì‹œì§€ ì˜ì—­ -->
                <div id="chatMessages" class="flex-1 overflow-y-auto custom-scrollbar p-6 space-y-4">
                    <!-- ì›°ì»´ ë©”ì‹œì§€ -->
                    <div class="flex justify-start">
                        <div class="chat-message-ai">
                            <p>ì•ˆë…•í•˜ì„¸ìš”! ì´ì•¼ê¸°ë¥¼ ì–´ë–»ê²Œ ìˆ˜ì •í•˜ê±°ë‚˜ ê°œì„ í•˜ê³  ì‹¶ìœ¼ì‹ ê°€ìš”?</p>
                        </div>
                    </div>
                    
                    <!-- ë©”ì‹œì§€ë“¤ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
                </div>
                
                <!-- ì…ë ¥ ì˜ì—­ -->
                <div class="p-4 bg-white border-t border-gray-200">
                    <!-- ë¹ ë¥¸ ëª…ë ¹ì–´ ë²„íŠ¼ë“¤ -->
                    <div class="flex flex-wrap gap-2 mb-3">
                        <button class="quick-command-btn px-3 py-1.5 bg-gray-100 text-gray-700 rounded-full text-sm hover:bg-gray-200 transition-colors">
                            ë” ì¬ë¯¸ìˆê²Œ
                        </button>
                        <button class="quick-command-btn px-3 py-1.5 bg-gray-100 text-gray-700 rounded-full text-sm hover:bg-gray-200 transition-colors">
                            ê°ì • í‘œí˜„ ê°•í™”
                        </button>
                        <button class="quick-command-btn px-3 py-1.5 bg-gray-100 text-gray-700 rounded-full text-sm hover:bg-gray-200 transition-colors">
                            ë¬¸ì¥ ê°„ê²°í•˜ê²Œ
                        </button>
                        <button class="quick-command-btn px-3 py-1.5 bg-gray-100 text-gray-700 rounded-full text-sm hover:bg-gray-200 transition-colors">
                            ë§ì¶¤ë²• ê²€ì‚¬
                        </button>
                    </div>
                    
                    <!-- AI ëª¨ë¸ ì„ íƒ -->
                    <div class="flex items-center gap-2 mb-3 px-1">
                        <label for="aiModelSelect" class="text-sm font-medium text-gray-700 flex items-center gap-1.5 whitespace-nowrap">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 3v2m6-2v2M9 19v2m6-2v2M5 9H3m2 6H3m18-6h-2m2 6h-2M7 19h10a2 2 0 002-2V7a2 2 0 00-2-2H7a2 2 0 00-2 2v10a2 2 0 002 2zM9 9h6v6H9V9z"/>
                            </svg>
                            AI ëª¨ë¸
                        </label>
                        <select id="aiModelSelect" class="flex-1 px-3 py-2 bg-white border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all cursor-pointer hover:border-gray-400">
                            <option value="claude-4.5" selected>Claude 4.5</option>
                            <option value="gpt-4o">GPT-4o</option>
                        </select>
                    </div>
                    
                    <!-- ë©”ì‹œì§€ ì…ë ¥ í¼ -->
                    <div class="flex gap-2 items-stretch">
                        <textarea 
                            id="messageInput" 
                            class="flex-1 px-4 py-3 border border-gray-300 rounded-lg chat-input resize-none focus:border-blue-500 transition-colors overflow-y-auto"
                            placeholder="AIì—ê²Œ ìˆ˜ì • ìš”ì²­ì„ ì…ë ¥í•˜ì„¸ìš”..."
                            rows="2"
                            style="max-height: 120px;"></textarea>
                        <button 
                            id="sendMessageBtn" 
                            class="px-6 py-3 bg-gradient-to-r from-blue-600 to-purple-600 text-white rounded-lg hover:from-blue-700 hover:to-purple-700 transition-all duration-200 shadow-md hover:shadow-lg flex items-center justify-center">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/>
                            </svg>
                        </button>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        // ì „ì—­ ë³€ìˆ˜
        let storyData = null;
        let originalStory = null; // ì›ë³¸ ì´ì•¼ê¸° ì €ì¥
        let storyHistory = []; // ìˆ˜ì • íˆìŠ¤í† ë¦¬ ìŠ¤íƒ
        let redoHistory = []; // ë‹¤ì‹œ ì‹¤í–‰ íˆìŠ¤í† ë¦¬ ìŠ¤íƒ
        
        // API ë¡œê·¸ í•¨ìˆ˜
        function appendApiLog(type, data) {
            const logContent = document.getElementById('apiLogContent');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${type}\n${JSON.stringify(data, null, 2)}\n${'â”€'.repeat(50)}\n`;
            logContent.textContent = logEntry + logContent.textContent;
        }
        
        // OpenRouter í‚¤ ê°€ì ¸ì˜¤ê¸°
        function getOpenRouterKey() {
            const key = document.getElementById('openrouterKey').value.trim();
            if (!key) {
                alert('âš ï¸ OpenRouter API í‚¤ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”!');
                return null;
            }
            return key;
        }
        
        // API ë¡œê·¸ í† ê¸€
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('toggleApiLogBtn').addEventListener('click', function() {
                const logSection = document.getElementById('apiLogSection');
                logSection.classList.toggle('hidden');
                this.classList.toggle('bg-blue-100');
            });
            
            document.getElementById('clearApiLogBtn').addEventListener('click', function() {
                document.getElementById('apiLogContent').textContent = 'ë¡œê·¸ê°€ ì§€ì›Œì¡ŒìŠµë‹ˆë‹¤.';
            });
        });
        
        // HOOK, BODY, CTAì˜ ì›ë³¸ ë‚´ìš© ì €ì¥
        let originalHook = '';
        let originalBody = '';
        let originalCta = '';
        
        // í˜„ì¬ ë³€ê²½ì‚¬í•­ ì¶”ì 
        let hasChanges = false;
        
        // HTML ì´ìŠ¤ì¼€ì´í”„ í•¨ìˆ˜
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // ì´ì•¼ê¸°ì—ì„œ BODY ë‚´ìš© ì¶”ì¶œ í•¨ìˆ˜
        function extractBodyContent(content) {
            // GPT ë¶„ì„ ê²°ê³¼ ë¶„ë¦¬
            const parts = content.split('=== GPT ë¶„ì„ ê²°ê³¼ ===');
            const storyText = parts[0].trim();
            
            // ì œëª© ë¶€ë¶„ ì œê±° (ì²« ë²ˆì§¸ ì¤„)
            const lines = storyText.split('\n');
            const bodyContent = lines.slice(1).join('\n').trim();
            
            return bodyContent;
        }
        
        // ì œëª© ì¶”ì¶œ í•¨ìˆ˜
        function extractTitle(content) {
            const parts = content.split('=== GPT ë¶„ì„ ê²°ê³¼ ===');
            const storyText = parts[0].trim();
            const lines = storyText.split('\n');
            const titleLine = lines[0];
            
            // "ì œëª©:" ì ‘ë‘ì‚¬ ì œê±°
            return titleLine.replace('ì œëª©:', '').trim();
        }
        
        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ì•¼ê¸° ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ì´ì•¼ê¸° ê°€ê³µ í˜ì´ì§€ ë¡œë“œë¨');
            
            // localStorageì—ì„œ ì´ì•¼ê¸° ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
            const savedData = localStorage.getItem('storyToRefine');
            
            if (!savedData) {
                // ë°ì´í„°ê°€ ì—†ìœ¼ë©´ ë©”ì¸ í˜ì´ì§€ë¡œ ëŒì•„ê°€ê¸°
                alert('ê°€ê³µí•  ì´ì•¼ê¸°ê°€ ì—†ìŠµë‹ˆë‹¤. ë©”ì¸ í˜ì´ì§€ë¡œ ëŒì•„ê°‘ë‹ˆë‹¤.');
                window.location.href = 'api_test.html';
                return;
            }
            
            try {
                storyData = JSON.parse(savedData);
                originalStory = JSON.parse(JSON.stringify(storyData)); // ê¹Šì€ ë³µì‚¬ë¡œ ì›ë³¸ ì €ì¥
                
                console.log('ë¶ˆëŸ¬ì˜¨ ì´ì•¼ê¸° ë°ì´í„°:', storyData);
                
                // ì´ì•¼ê¸° ì œëª© í‘œì‹œ
                const title = extractTitle(storyData.content);
                document.getElementById('storyTitle').textContent = title;
                
                // ì´ì•¼ê¸° BODY ë‚´ìš© í‘œì‹œ
                const bodyContent = extractBodyContent(storyData.content);
                document.getElementById('storyContent').value = bodyContent;
                
                // ì›ë³¸ ë‚´ìš© ì €ì¥
                saveOriginalContent();
                
                // ì´ˆê¸° ìƒíƒœë¥¼ íˆìŠ¤í† ë¦¬ì— ì¶”ê°€ (hook, body, cta í˜•ì‹ìœ¼ë¡œ)
                const initialState = {
                    hook: document.getElementById('hookContent').value,
                    body: document.getElementById('storyContent').value,
                    cta: document.getElementById('ctaContent').value
                };
                storyHistory.push(initialState);
                
                // í…ìŠ¤íŠ¸ ì˜ì—­ì— ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
                document.getElementById('hookContent').addEventListener('input', checkForChanges);
                document.getElementById('storyContent').addEventListener('input', checkForChanges);
                document.getElementById('ctaContent').addEventListener('input', checkForChanges);
                
                updateUndoButton();
                
            } catch (error) {
                console.error('ì´ì•¼ê¸° ë°ì´í„° íŒŒì‹± ì˜¤ë¥˜:', error);
                alert('ì´ì•¼ê¸° ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                window.location.href = 'api_test.html';
            }
        });
        
        // Undo/Redo ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
        function updateUndoButton() {
            const undoBtn = document.getElementById('undoBtn');
            const redoBtn = document.getElementById('redoBtn');
            
            // íˆìŠ¤í† ë¦¬ê°€ ìˆê±°ë‚˜ í…ìŠ¤íŠ¸ ì˜ì—­ì— ë³€ê²½ì‚¬í•­ì´ ìˆìœ¼ë©´ Undo í™œì„±í™”
            if (storyHistory.length > 1 || hasChanges) {
                undoBtn.disabled = false;
            } else {
                undoBtn.disabled = true;
            }
            
            // Redo íˆìŠ¤í† ë¦¬ê°€ ìˆìœ¼ë©´ Redo í™œì„±í™”
            if (redoHistory.length > 0) {
                redoBtn.disabled = false;
            } else {
                redoBtn.disabled = true;
            }
        }
        
        // ë³€ê²½ì‚¬í•­ í™•ì¸ í•¨ìˆ˜
        function checkForChanges() {
            const hookContent = document.getElementById('hookContent').value;
            const bodyContent = document.getElementById('storyContent').value;
            const ctaContent = document.getElementById('ctaContent').value;
            
            hasChanges = (hookContent !== originalHook) || 
                        (bodyContent !== originalBody) || 
                        (ctaContent !== originalCta);
            
            updateUndoButton();
        }
        
        // í…ìŠ¤íŠ¸ ì˜ì—­ ë³€ê²½ì‚¬í•­ ë˜ëŒë¦¬ê¸° í•¨ìˆ˜
        function undoTextChanges() {
            document.getElementById('hookContent').value = originalHook;
            document.getElementById('storyContent').value = originalBody;
            document.getElementById('ctaContent').value = originalCta;
            hasChanges = false;
            updateUndoButton();
        }
        
        // ì›ë³¸ ë‚´ìš© ì €ì¥ í•¨ìˆ˜
        function saveOriginalContent() {
            originalHook = document.getElementById('hookContent').value;
            originalBody = document.getElementById('storyContent').value;
            originalCta = document.getElementById('ctaContent').value;
        }
        
        // ì´ì•¼ê¸° ì—…ë°ì´íŠ¸ ë° íˆìŠ¤í† ë¦¬ ì €ì¥
        function updateStory(newContent) {
            storyHistory.push(JSON.parse(JSON.stringify(storyData)));
            storyData.content = newContent;
            
            // í™”ë©´ ì—…ë°ì´íŠ¸
            const title = extractTitle(storyData.content);
            document.getElementById('storyTitle').textContent = title;
            
            const bodyContent = extractBodyContent(storyData.content);
            document.getElementById('storyContent').value = bodyContent;
            
            // ì›ë³¸ ë‚´ìš© ì—…ë°ì´íŠ¸ ë° ë³€ê²½ì‚¬í•­ ì´ˆê¸°í™”
            saveOriginalContent();
            hasChanges = false;
            
            updateUndoButton();
        }
        
        // ë³µì‚¬ ê¸°ëŠ¥ (ê³µí†µ í•¨ìˆ˜)
        function copyStory(btn) {
            // HOOK, BODY, CTA ë‚´ìš© ê°€ì ¸ì˜¤ê¸°
            const hookContent = document.getElementById('hookContent').value.trim();
            const bodyContent = document.getElementById('storyContent').value.trim();
            const ctaContent = document.getElementById('ctaContent').value.trim();
            
            // ë³µì‚¬í•  ë‚´ìš©ì´ í•˜ë‚˜ë„ ì—†ìœ¼ë©´
            if (!hookContent && !bodyContent && !ctaContent) {
                alert('ë³µì‚¬í•  ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            
            // ì „ì²´ ë‚´ìš© ì¡°í•© (ì œëª© ì œì™¸)
            let fullContent = '';
            
            if (hookContent) {
                fullContent += hookContent + '\n\n';
            }
            
            if (bodyContent) {
                fullContent += bodyContent + '\n\n';
            }
            
            if (ctaContent) {
                fullContent += ctaContent;
            }
            
            // í´ë¦½ë³´ë“œì— ë³µì‚¬
            navigator.clipboard.writeText(fullContent.trim()).then(function() {
                const originalHTML = btn.innerHTML;
                const originalClasses = btn.className;
                
                // ë²„íŠ¼ ë³€ê²½ (ì²´í¬ ì•„ì´ì½˜)
                btn.innerHTML = `
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                    </svg>
                `;
                btn.className = 'p-2 text-green-600 bg-green-50 rounded-lg';
                
                // 2ì´ˆ í›„ ì›ë˜ëŒ€ë¡œ
                setTimeout(function() {
                    btn.innerHTML = originalHTML;
                    btn.className = originalClasses;
                }, 2000);
            }).catch(function(error) {
                console.error('ë³µì‚¬ ì‹¤íŒ¨:', error);
                alert('ë³µì‚¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            });
        }
        
        // ì›ë³¸ìœ¼ë¡œ ë˜ëŒë¦¬ê¸° ê¸°ëŠ¥ (ê³µí†µ í•¨ìˆ˜)
        function resetStory() {
            if (!originalStory) {
                alert('ì›ë³¸ ì´ì•¼ê¸°ê°€ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            
            if (confirm('ì›ë³¸ ì´ì•¼ê¸°ë¡œ ë˜ëŒë¦¬ì‹œê² ìŠµë‹ˆê¹Œ? í˜„ì¬ ìˆ˜ì •ëœ ë‚´ìš©ê³¼ íˆìŠ¤í† ë¦¬ëŠ” ëª¨ë‘ ì‚¬ë¼ì§‘ë‹ˆë‹¤.')) {
                storyData = JSON.parse(JSON.stringify(originalStory)); // ê¹Šì€ ë³µì‚¬
                
                // í™”ë©´ ì—…ë°ì´íŠ¸
                const title = extractTitle(storyData.content);
                document.getElementById('storyTitle').textContent = title;
                
                const bodyContent = extractBodyContent(storyData.content);
                document.getElementById('storyContent').value = bodyContent;
                
                // HOOK, CTAëŠ” ë¹ˆ ë¬¸ìì—´ë¡œ
                document.getElementById('hookContent').value = '';
                document.getElementById('ctaContent').value = '';
                
                // ì›ë³¸ ë‚´ìš© ì—…ë°ì´íŠ¸ ë° ë³€ê²½ì‚¬í•­ ì´ˆê¸°í™”
                saveOriginalContent();
                hasChanges = false;
                
                // íˆìŠ¤í† ë¦¬ ì´ˆê¸°í™” (hook, body, cta í˜•ì‹ìœ¼ë¡œ)
                const initialState = {
                    hook: '',
                    body: bodyContent,
                    cta: ''
                };
                storyHistory = [initialState];
                redoHistory = []; // Redo íˆìŠ¤í† ë¦¬ë„ ì´ˆê¸°í™”
                
                updateUndoButton();
                alert('ì›ë³¸ ì´ì•¼ê¸°ë¡œ ë˜ëŒë ¸ìŠµë‹ˆë‹¤.');
            }
        }
        
        // ìƒë‹¨ ë³µì‚¬ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
        document.getElementById('copyStoryBtnTop').addEventListener('click', function() {
            copyStory(this);
        });
        
        // ìƒë‹¨ ì›ë³¸ìœ¼ë¡œ ë˜ëŒë¦¬ê¸° ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
        document.getElementById('resetStoryBtnTop').addEventListener('click', function() {
            resetStory();
        });
        
        // Undo ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
        document.getElementById('undoBtn').addEventListener('click', function() {
            // í…ìŠ¤íŠ¸ ì˜ì—­ì— ë³€ê²½ì‚¬í•­ì´ ìˆìœ¼ë©´ ë¨¼ì € ë˜ëŒë¦¬ê¸°
            if (hasChanges) {
                // í˜„ì¬ ìƒíƒœë¥¼ Redo íˆìŠ¤í† ë¦¬ì— ì €ì¥
                const currentState = {
                    hook: document.getElementById('hookContent').value,
                    body: document.getElementById('storyContent').value,
                    cta: document.getElementById('ctaContent').value
                };
                redoHistory.push(currentState);
                
                undoTextChanges();
            }
            // íˆìŠ¤í† ë¦¬ê°€ ìˆìœ¼ë©´ ì´ì „ ìƒíƒœë¡œ ë³µì›
            else if (storyHistory.length > 1) {
                // í˜„ì¬ ìƒíƒœë¥¼ Redo íˆìŠ¤í† ë¦¬ì— ì €ì¥
                const currentState = {
                    hook: document.getElementById('hookContent').value,
                    body: document.getElementById('storyContent').value,
                    cta: document.getElementById('ctaContent').value
                };
                redoHistory.push(currentState);
                
                storyHistory.pop(); // í˜„ì¬ ìƒíƒœ ì œê±°
                const previousState = storyHistory[storyHistory.length - 1]; // ì´ì „ ìƒíƒœ ê°€ì ¸ì˜¤ê¸°
                
                // í™”ë©´ ì—…ë°ì´íŠ¸ (hook, body, cta í˜•ì‹)
                document.getElementById('hookContent').value = previousState.hook || '';
                document.getElementById('storyContent').value = previousState.body || '';
                document.getElementById('ctaContent').value = previousState.cta || '';
                
                // ì›ë³¸ ë‚´ìš© ì—…ë°ì´íŠ¸
                saveOriginalContent();
                
                updateUndoButton();
            }
        });
        
        // Redo ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
        document.getElementById('redoBtn').addEventListener('click', function() {
            if (redoHistory.length > 0) {
                // í˜„ì¬ ìƒíƒœë¥¼ íˆìŠ¤í† ë¦¬ì— ì €ì¥
                const currentState = {
                    hook: document.getElementById('hookContent').value,
                    body: document.getElementById('storyContent').value,
                    cta: document.getElementById('ctaContent').value
                };
                storyHistory.push(currentState);
                
                // Redo íˆìŠ¤í† ë¦¬ì—ì„œ ë‹¤ìŒ ìƒíƒœ ê°€ì ¸ì˜¤ê¸°
                const nextState = redoHistory.pop();
                
                // í™”ë©´ ì—…ë°ì´íŠ¸
                document.getElementById('hookContent').value = nextState.hook || '';
                document.getElementById('storyContent').value = nextState.body || '';
                document.getElementById('ctaContent').value = nextState.cta || '';
                
                // ì›ë³¸ ë‚´ìš© ì—…ë°ì´íŠ¸
                saveOriginalContent();
                hasChanges = false;
                
                updateUndoButton();
            }
        });
        
        // ìƒˆ ì±„íŒ… ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
        document.getElementById('newChatBtn').addEventListener('click', function() {
            if (confirm('ìƒˆ ì±„íŒ…ì„ ì‹œì‘í•˜ì‹œê² ìŠµë‹ˆê¹Œ? í˜„ì¬ ëŒ€í™” ë‚´ì—­ì€ ì‚­ì œë©ë‹ˆë‹¤.')) {
                const chatMessages = document.getElementById('chatMessages');
                // ì›°ì»´ ë©”ì‹œì§€ë§Œ ë‚¨ê¸°ê³  ëª¨ë‘ ì‚­ì œ
                const welcomeMessage = chatMessages.querySelector('.chat-message-ai').parentElement;
                chatMessages.innerHTML = '';
                chatMessages.appendChild(welcomeMessage);
                
                // ëŒ€í™” íˆìŠ¤í† ë¦¬ ì´ˆê¸°í™”
                conversationHistory = [];
            }
        });
        
        // ëŒ€í™” íˆìŠ¤í† ë¦¬ ì €ì¥
        let conversationHistory = [];
        
        // AI ì‘ë‹µ íŒŒì‹± í•¨ìˆ˜
        function parseAiResponse(responseText) {
            const result = {
                hook: null,
                body: null,
                cta: null,
                message: ''
            };
            
            // response: ë¶€ë¶„ ì¶”ì¶œ
            const responseMatch = responseText.match(/response:\s*([\s\S]*?)(?=\n==|$)/i);
            if (responseMatch) {
                result.message = responseMatch[1].trim();
            } else {
                // response: íƒœê·¸ê°€ ì—†ìœ¼ë©´ ì „ì²´ë¥¼ ë©”ì‹œì§€ë¡œ ì‚¬ìš©
                result.message = responseText.trim();
            }
            
            // == HOOK == ë¶€ë¶„ ì¶”ì¶œ
            const hookMatch = responseText.match(/==\s*HOOK\s*==\s*([\s\S]*?)(?=\n==|response:|$)/i);
            if (hookMatch) {
                const hookContent = hookMatch[1].trim();
                if (hookContent && hookContent !== '(ìˆ˜ì • ì—†ìŒ)' && hookContent !== '[ìˆ˜ì •ëœ ë¶€ë¶„ì´ ìˆì„ ê²½ìš°, ìˆ˜ì •ëœ HOOK í…ìŠ¤íŠ¸]') {
                    result.hook = hookContent;
                }
            }
            
            // == BODY == ë¶€ë¶„ ì¶”ì¶œ
            const bodyMatch = responseText.match(/==\s*BODY\s*==\s*([\s\S]*?)(?=\n==|response:|$)/i);
            if (bodyMatch) {
                const bodyContent = bodyMatch[1].trim();
                if (bodyContent && bodyContent !== '(ìˆ˜ì • ì—†ìŒ)' && bodyContent !== '[ìˆ˜ì •ëœ ë¶€ë¶„ì´ ìˆì„ ê²½ìš°, ìˆ˜ì •ëœ BODY í…ìŠ¤íŠ¸]') {
                    result.body = bodyContent;
                }
            }
            
            // == CTA == ë¶€ë¶„ ì¶”ì¶œ
            const ctaMatch = responseText.match(/==\s*CTA\s*==\s*([\s\S]*?)(?=\n==|response:|$)/i);
            if (ctaMatch) {
                const ctaContent = ctaMatch[1].trim();
                if (ctaContent && ctaContent !== '(ìˆ˜ì • ì—†ìŒ)' && ctaContent !== '[ìˆ˜ì •ëœ ë¶€ë¶„ì´ ìˆì„ ê²½ìš°, ìˆ˜ì •ëœ CTA í…ìŠ¤íŠ¸]') {
                    result.cta = ctaContent;
                }
            }
            
            return result;
        }
        
        // ë©”ì‹œì§€ ì „ì†¡ ê¸°ëŠ¥
        async function sendMessage() {
            const messageInput = document.getElementById('messageInput');
            const message = messageInput.value.trim();
            
            if (message === '') {
                return;
            }
            
            // OpenRouter í‚¤ í™•ì¸
            const openrouterKey = getOpenRouterKey();
            if (!openrouterKey) return;
            
            // ì„ íƒëœ AI ëª¨ë¸ ê°€ì ¸ì˜¤ê¸°
            const selectedModel = document.getElementById('aiModelSelect').value;
            
            // ì‚¬ìš©ì ë©”ì‹œì§€ ì¶”ê°€
            addUserMessage(message);
            
            // ëŒ€í™” íˆìŠ¤í† ë¦¬ì— ì¶”ê°€
            conversationHistory.push({
                role: 'user',
                content: message
            });
            
            // ì…ë ¥ì°½ ì´ˆê¸°í™” ë° ë¹„í™œì„±í™”
            messageInput.value = '';
            messageInput.disabled = true;
            document.getElementById('sendMessageBtn').disabled = true;
            
            // ë¡œë”© ì¸ë””ì¼€ì´í„° ì¶”ê°€
            const loadingId = addLoadingIndicator();
            
            try {
                // í˜„ì¬ HOOK, BODY, CTA ë‚´ìš© ê°€ì ¸ì˜¤ê¸°
                const hookContent = document.getElementById('hookContent').value;
                const bodyContent = document.getElementById('storyContent').value;
                const ctaContent = document.getElementById('ctaContent').value;
                
                // ìš”ì²­ ë°ì´í„° êµ¬ì„±
                const requestData = {
                    _openrouter_key: openrouterKey,
                    model: selectedModel,
                    message: message,
                    hookContent: hookContent,
                    bodyContent: bodyContent,
                    ctaContent: ctaContent,
                    conversationHistory: conversationHistory
                };
                
                // API ë¡œê·¸ - ìš”ì²­
                appendApiLog('ğŸ“¤ REQUEST (refine_story.php)', {
                    ...requestData,
                    _openrouter_key: '***hidden***'
                });
                
                // API ìš”ì²­
                const response = await fetch('../refine_story.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestData)
                });
                
                const result = await response.json();
                
                // API ë¡œê·¸ - ì‘ë‹µ
                appendApiLog('ğŸ“¥ RESPONSE (refine_story.php)', result);
                
                // ë¡œë”© ì¸ë””ì¼€ì´í„° ì œê±°
                removeLoadingIndicator(loadingId);
                
                if (result.error) {
                    addAiMessage('âŒ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + result.error);
                    console.error('API ì˜¤ë¥˜:', result);
                } else {
                    // AI ì‘ë‹µ íŒŒì‹±
                    const parsedResponse = parseAiResponse(result.response);
                    
                    // HOOK, BODY, CTA ì—…ë°ì´íŠ¸
                    let hasUpdates = false;
                    
                    // ì—…ë°ì´íŠ¸ ì „ í˜„ì¬ ìƒíƒœë¥¼ íˆìŠ¤í† ë¦¬ì— ì €ì¥
                    const currentState = {
                        hook: document.getElementById('hookContent').value,
                        body: document.getElementById('storyContent').value,
                        cta: document.getElementById('ctaContent').value
                    };
                    
                    if (parsedResponse.hook !== null) {
                        document.getElementById('hookContent').value = parsedResponse.hook;
                        hasUpdates = true;
                    }
                    
                    if (parsedResponse.body !== null) {
                        document.getElementById('storyContent').value = parsedResponse.body;
                        hasUpdates = true;
                    }
                    
                    if (parsedResponse.cta !== null) {
                        document.getElementById('ctaContent').value = parsedResponse.cta;
                        hasUpdates = true;
                    }
                    
                    // ì—…ë°ì´íŠ¸ê°€ ìˆì—ˆë‹¤ë©´ íˆìŠ¤í† ë¦¬ì— ì €ì¥í•˜ê³  ì›ë³¸ ë‚´ìš© ê°±ì‹ 
                    if (hasUpdates) {
                        storyHistory.push(currentState);
                        redoHistory = []; // ìƒˆë¡œìš´ ë³€ê²½ì´ë¯€ë¡œ Redo íˆìŠ¤í† ë¦¬ ì´ˆê¸°í™”
                        saveOriginalContent();
                        hasChanges = false;
                        updateUndoButton();
                    }
                    
                    // ì±„íŒ…ì°½ì—ëŠ” response ë¶€ë¶„ë§Œ í‘œì‹œ
                    addAiMessage(parsedResponse.message);
                    
                    // ëŒ€í™” íˆìŠ¤í† ë¦¬ì— ì¶”ê°€ (ì „ì²´ ì‘ë‹µ ì €ì¥)
                    conversationHistory.push({
                        role: 'assistant',
                        content: result.response
                    });
                }
                
            } catch (error) {
                // ë¡œë”© ì¸ë””ì¼€ì´í„° ì œê±°
                removeLoadingIndicator(loadingId);
                addAiMessage('âŒ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
                console.error('ìš”ì²­ ì˜¤ë¥˜:', error);
            } finally {
                // ì…ë ¥ì°½ ë‹¤ì‹œ í™œì„±í™”
                messageInput.disabled = false;
                document.getElementById('sendMessageBtn').disabled = false;
                messageInput.focus();
            }
        }
        
        // ì‚¬ìš©ì ë©”ì‹œì§€ ì¶”ê°€ í•¨ìˆ˜
        function addUserMessage(message) {
            const chatMessages = document.getElementById('chatMessages');
            
            const messageDiv = document.createElement('div');
            messageDiv.className = 'flex justify-end';
            
            const messageContent = document.createElement('div');
            messageContent.className = 'chat-message-user';
            
            // ì¤„ë°”ê¿ˆ ì²˜ë¦¬
            messageContent.innerHTML = escapeHtml(message).replace(/\n/g, '<br>');
            
            messageDiv.appendChild(messageContent);
            chatMessages.appendChild(messageDiv);
            
            // ìŠ¤í¬ë¡¤ì„ ìµœí•˜ë‹¨ìœ¼ë¡œ
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
        
        // AI ë©”ì‹œì§€ ì¶”ê°€ í•¨ìˆ˜
        function addAiMessage(message) {
            const chatMessages = document.getElementById('chatMessages');
            
            const messageDiv = document.createElement('div');
            messageDiv.className = 'flex justify-start';
            
            const messageContent = document.createElement('div');
            messageContent.className = 'chat-message-ai';
            messageContent.innerHTML = escapeHtml(message).replace(/\n/g, '<br>');
            
            messageDiv.appendChild(messageContent);
            chatMessages.appendChild(messageDiv);
            
            // ìŠ¤í¬ë¡¤ì„ ìµœí•˜ë‹¨ìœ¼ë¡œ
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
        
        // ë¡œë”© ì¸ë””ì¼€ì´í„° ì¶”ê°€ í•¨ìˆ˜
        function addLoadingIndicator() {
            const chatMessages = document.getElementById('chatMessages');
            
            const messageDiv = document.createElement('div');
            messageDiv.className = 'flex justify-start';
            messageDiv.id = 'loading-indicator-' + Date.now();
            
            const loadingContent = document.createElement('div');
            loadingContent.className = 'chat-message-ai';
            loadingContent.innerHTML = '<div class="typing-indicator"><div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div></div>';
            
            messageDiv.appendChild(loadingContent);
            chatMessages.appendChild(messageDiv);
            
            // ìŠ¤í¬ë¡¤ì„ ìµœí•˜ë‹¨ìœ¼ë¡œ
            chatMessages.scrollTop = chatMessages.scrollHeight;
            
            return messageDiv.id;
        }
        
        // ë¡œë”© ì¸ë””ì¼€ì´í„° ì œê±° í•¨ìˆ˜
        function removeLoadingIndicator(loadingId) {
            const loadingElement = document.getElementById(loadingId);
            if (loadingElement) {
                loadingElement.remove();
            }
        }
        
        // ì „ì†¡ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
        document.getElementById('sendMessageBtn').addEventListener('click', function() {
            sendMessage();
        });
        
        // Enter í‚¤ ì´ë²¤íŠ¸ ì²˜ë¦¬
        document.getElementById('messageInput').addEventListener('keydown', function(e) {
            // Enter í‚¤ (Shift, Ctrl ì—†ì´)
            if (e.key === 'Enter' && !e.shiftKey && !e.ctrlKey) {
                e.preventDefault();
                sendMessage();
            }
            // Shift+Enter ë˜ëŠ” Ctrl+EnterëŠ” ê¸°ë³¸ ë™ì‘(ì¤„ë°”ê¿ˆ) í—ˆìš©
        });
        
        // ë¹ ë¥¸ ëª…ë ¹ì–´ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
        document.querySelectorAll('.quick-command-btn').forEach(function(btn) {
            btn.addEventListener('click', function() {
                const command = this.textContent.trim();
                const messageInput = document.getElementById('messageInput');
                messageInput.value = command;
                messageInput.focus();
            });
        });
        
        // HOOK ìë™ìƒì„± ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
        document.getElementById('generateHookBtn').addEventListener('click', async function() {
            const bodyContent = document.getElementById('storyContent').value.trim();
            const hookType = document.getElementById('hookTypeSelect').value;
            
            if (!bodyContent) {
                alert('BODY ë‚´ìš©ì´ ë¹„ì–´ìˆìŠµë‹ˆë‹¤. HOOKì„ ìƒì„±í•˜ë ¤ë©´ ë¨¼ì € BODY ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }
            
            // OpenRouter í‚¤ í™•ì¸
            const openrouterKey = getOpenRouterKey();
            if (!openrouterKey) return;
            
            const generateBtn = this;
            const originalText = generateBtn.textContent;
            
            // ë²„íŠ¼ ë¹„í™œì„±í™” ë° ë¡œë”© ìƒíƒœ
            generateBtn.disabled = true;
            generateBtn.textContent = 'ìƒì„± ì¤‘...';
            
            // ìš”ì²­ ë°ì´í„° êµ¬ì„±
            const requestData = {
                _openrouter_key: openrouterKey,
                bodyContent: bodyContent,
                hookType: hookType
            };
            
            // API ë¡œê·¸ - ìš”ì²­
            appendApiLog('ğŸ“¤ REQUEST (generate_hook.php)', {
                ...requestData,
                _openrouter_key: '***hidden***'
            });
            
            try {
                // generate_hook.php API í˜¸ì¶œ
                const response = await fetch('../generate_hook.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestData)
                });
                
                const result = await response.json();
                
                // API ë¡œê·¸ - ì‘ë‹µ
                appendApiLog('ğŸ“¥ RESPONSE (generate_hook.php)', result);
                
                if (result.error) {
                    alert('âŒ HOOK ìƒì„± ì˜¤ë¥˜: ' + result.error);
                    console.error('HOOK ìƒì„± ì˜¤ë¥˜:', result);
                } else if (result.success && result.raw_response) {
                    // í˜„ì¬ ìƒíƒœë¥¼ íˆìŠ¤í† ë¦¬ì— ì €ì¥
                    const currentState = {
                        hook: document.getElementById('hookContent').value,
                        body: document.getElementById('storyContent').value,
                        cta: document.getElementById('ctaContent').value
                    };
                    storyHistory.push(currentState);
                    redoHistory = []; // ìƒˆë¡œìš´ ë³€ê²½ì´ë¯€ë¡œ Redo íˆìŠ¤í† ë¦¬ ì´ˆê¸°í™”
                    
                    // ìƒì„±ëœ HOOK ì›ë³¸ ì‘ë‹µì„ ê·¸ëŒ€ë¡œ HOOK í…ìŠ¤íŠ¸ ì˜ì—­ì— í‘œì‹œ
                    document.getElementById('hookContent').value = result.raw_response.trim();
                    
                    // ì›ë³¸ ë‚´ìš© ê°±ì‹ 
                    saveOriginalContent();
                    hasChanges = false;
                    updateUndoButton();
                    
                    // ì„±ê³µ í”¼ë“œë°±
                    generateBtn.textContent = 'âœ“ ìƒì„±ì™„ë£Œ';
                    generateBtn.className = 'text-xs bg-green-600 text-white rounded transition-colors';
                    
                    setTimeout(function() {
                        generateBtn.textContent = originalText;
                        generateBtn.className = 'text-xs bg-blue-600 text-white rounded hover:bg-blue-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed';
                        generateBtn.disabled = false;
                    }, 2000);
                } else {
                    alert('âŒ HOOK ìƒì„± ì‹¤íŒ¨: ì‘ë‹µì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.');
                    console.error('ì˜ëª»ëœ ì‘ë‹µ:', result);
                    generateBtn.textContent = originalText;
                    generateBtn.disabled = false;
                }
                
            } catch (error) {
                alert('âŒ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜: ' + error.message);
                console.error('ìš”ì²­ ì˜¤ë¥˜:', error);
                generateBtn.textContent = originalText;
                generateBtn.disabled = false;
            }
        });
        
        // CTA ìë™ìƒì„± ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
        document.getElementById('generateCtaBtn').addEventListener('click', async function() {
            const bodyContent = document.getElementById('storyContent').value.trim();
            const ctaType = document.getElementById('ctaTypeSelect').value;
            
            if (!bodyContent) {
                alert('BODY ë‚´ìš©ì´ ë¹„ì–´ìˆìŠµë‹ˆë‹¤. CTAë¥¼ ìƒì„±í•˜ë ¤ë©´ ë¨¼ì € BODY ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }
            
            // OpenRouter í‚¤ í™•ì¸
            const openrouterKey = getOpenRouterKey();
            if (!openrouterKey) return;
            
            const generateBtn = this;
            const originalText = generateBtn.textContent;
            
            // ë²„íŠ¼ ë¹„í™œì„±í™” ë° ë¡œë”© ìƒíƒœ
            generateBtn.disabled = true;
            generateBtn.textContent = 'ìƒì„± ì¤‘...';
            
            // ìš”ì²­ ë°ì´í„° êµ¬ì„±
            const requestData = {
                _openrouter_key: openrouterKey,
                bodyContent: bodyContent,
                ctaType: ctaType
            };
            
            // API ë¡œê·¸ - ìš”ì²­
            appendApiLog('ğŸ“¤ REQUEST (generate_cta.php)', {
                ...requestData,
                _openrouter_key: '***hidden***'
            });
            
            try {
                // generate_cta.php API í˜¸ì¶œ
                const response = await fetch('../generate_cta.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestData)
                });
                
                const result = await response.json();
                
                // API ë¡œê·¸ - ì‘ë‹µ
                appendApiLog('ğŸ“¥ RESPONSE (generate_cta.php)', result);
                
                if (result.error) {
                    alert('âŒ CTA ìƒì„± ì˜¤ë¥˜: ' + result.error);
                    console.error('CTA ìƒì„± ì˜¤ë¥˜:', result);
                } else if (result.success && result.raw_response) {
                    // í˜„ì¬ ìƒíƒœë¥¼ íˆìŠ¤í† ë¦¬ì— ì €ì¥
                    const currentState = {
                        hook: document.getElementById('hookContent').value,
                        body: document.getElementById('storyContent').value,
                        cta: document.getElementById('ctaContent').value
                    };
                    storyHistory.push(currentState);
                    redoHistory = []; // ìƒˆë¡œìš´ ë³€ê²½ì´ë¯€ë¡œ Redo íˆìŠ¤í† ë¦¬ ì´ˆê¸°í™”
                    
                    // ìƒì„±ëœ CTA ì›ë³¸ ì‘ë‹µì„ ê·¸ëŒ€ë¡œ CTA í…ìŠ¤íŠ¸ ì˜ì—­ì— í‘œì‹œ
                    document.getElementById('ctaContent').value = result.raw_response.trim();
                    
                    // ì›ë³¸ ë‚´ìš© ê°±ì‹ 
                    saveOriginalContent();
                    hasChanges = false;
                    updateUndoButton();
                    
                    // ì„±ê³µ í”¼ë“œë°±
                    generateBtn.textContent = 'âœ“ ìƒì„±ì™„ë£Œ';
                    generateBtn.className = 'text-xs bg-green-600 text-white rounded transition-colors';
                    
                    setTimeout(function() {
                        generateBtn.textContent = originalText;
                        generateBtn.className = 'text-xs bg-blue-600 text-white rounded hover:bg-blue-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed';
                        generateBtn.disabled = false;
                    }, 2000);
                } else {
                    alert('âŒ CTA ìƒì„± ì‹¤íŒ¨: ì‘ë‹µì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.');
                    console.error('ì˜ëª»ëœ ì‘ë‹µ:', result);
                    generateBtn.textContent = originalText;
                    generateBtn.disabled = false;
                }
                
            } catch (error) {
                alert('âŒ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜: ' + error.message);
                console.error('ìš”ì²­ ì˜¤ë¥˜:', error);
                generateBtn.textContent = originalText;
                generateBtn.disabled = false;
            }
        });
    </script>
</body>
</html>

